<style>
body {
	margin: 0px;
}
</style>
<body>
<button onclick="videoPlayer.play()">Play</button>
<button onclick="videoPlayer.pause()">Pause</button>
<button onclick="videoPlayer.muted(true)">Mute</button>
<button onclick="videoPlayer.muted(false)">UnMute</button>
<button onclick="videoPlayer.volume(50)">Volume 50</button>
<button onclick="videoPlayer.volume(100)">Volume 100</button>
<button onclick="videoPlayer.stop()">Stop</button>
<iframe
	style="width: 100%; height: 100vh;"
	src="https://rutube.ru/play/embed/19c634bf87424cd037b8ac7a90cee896"
	frameBorder="0"
	allow="clipboard-write;"
	webkitAllowFullScreen
	mozallowfullscreen
	allowFullScreen>
</iframe>
<script>
const webClient = {
	socket: null,
	connected: false,
	initClient() {
		const address = location.hash.substring(1);
		webClient.socket = new WebSocket(`ws://${address}/playerws`);

		webClient.socket.onclose = () => {
			console.log("web channel closed");
			webClient.connected = false;
		};
		webClient.socket.onerror = function(error) {
			console.error("web channel error: " + error);
		};
		webClient.socket.onopen = () => {
			console.log("socket opened");
			webClient.socket.send("ro:rt"); //define role of client
			this.connected = true;
		};
		webClient.socket.onmessage = (event) => {
			console.log(`message`, event.data);
			const message = event.data;
			const parts = message.split(':');
			if (parts.length < 2) return;
			
			const command = parts[0];
			const parameter = message.substring(command.length + 1);
			
			switch (command) {
				case "sc":
					videoPlayer.source(parameter);
					break;
				case "mt":
					if (parameter === 'true') videoPlayer.muted(true);
					if (parameter === 'false') videoPlayer.muted(false);
					break;
				case "vm":
					videoPlayer.volume(parseInt(parameter));
					break;
				case "st":
					if (parameter === 'play') videoPlayer.play();
					if (parameter === 'pause') videoPlayer.pause();
					if (parameter === 'stop') videoPlayer.stop();
					break;
				case "sk":
					videoPlayer.seek(parseInt(parameter));
					break;
			}
		}
	}
};
const videoPlayer = {
	root: null,
	iframe: null,
	loaded: false,
	initPlayer() {
		videoPlayer.iframe = document.getElementsByTagName('iframe')[0];
		videoPlayer.root = videoPlayer.iframe.contentWindow;
		
		window.addEventListener('message', function (event) {
			var message = JSON.parse(event.data);
			console.log(message.type);
			if (!videoPlayer.loaded && message.type === 'player:currentTime') {
				videoPlayer.loaded = true;
			}
			/*switch (message.type) {
				case 'player:changeState':
					console.log(message.data.state); // текущее состояние плеера
					break;
			};*/
		});
		
		webClient.initClient();		
	},
	sendMethod(method, methodData) {
		videoPlayer.root.postMessage(
			JSON.stringify({
				type: 'player:' + method,
				data: methodData
			}),
			'*'
		);
	},
	volume(newVolume) {
		videoPlayer.sendMethod('setVolume', {volume: newVolume / 100});
	},
	source(path) {
		const newSource = `https://rutube.ru/play/embed/${path}`;
		videoPlayer.iframe.src = newSource;
	},
	play() {
		videoPlayer.sendMethod('play', {});
	},
	pause() {
		videoPlayer.sendMethod('pause', {});
	},
	stop() {
		videoPlayer.sendMethod('stop', {});
	},
	muted(mute) {
		videoPlayer.sendMethod(mute ? 'mute' : 'unMute', {});
	},
	seek(position) {
		videoPlayer.sendMethod('setCurrentTime', { time: position / 1000 });
	}
};

setTimeout(videoPlayer.initPlayer, 2000);
</script>
</body>