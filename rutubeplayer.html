<style>
body {
	margin: 0px;
}
</style>
<body>
<!-- src="https://rutube.ru/play/embed/19c634bf87424cd037b8ac7a90cee896" -->
<iframe
	style="width: 100%; height: 100vh;"
	frameBorder="0"
	allow="clipboard-write;"
	webkitAllowFullScreen
	mozallowfullscreen
	allowFullScreen>
</iframe>
<script>
const webClient = {
	socket: null,
	connected: false,
	initClient() {
		const address = location.hash.substring(1);
		webClient.socket = new WebSocket(`ws://${address}/playerws`);

		webClient.socket.onclose = () => {
			console.log("web channel closed");
			webClient.connected = false;
		};
		webClient.socket.onerror = function(error) {
			console.error("web channel error: " + error);
		};
		webClient.socket.onopen = () => {
			console.log("socket opened");
			webClient.socket.send("ro:rt"); //define role of client
			this.connected = true;
			
			videoPlayer.initPlayer();
		};
		webClient.socket.onmessage = (event) => {
			const message = event.data;
			const parts = message.split(':');
			if (parts.length < 2) return;
			
			const command = parts[0];
			const parameter = message.substring(command.length + 1);
			
			switch (command) {
				case "sc":
					videoPlayer.source(parameter);
					break;
				case "mt":
					if (parameter === 'true') {
						videoPlayer.muted(true);
						break;
					}
					if (parameter === 'false') {
						videoPlayer.muted(false);
						break;
					}
					break;
				case "vm":
					videoPlayer.volume(parseInt(parameter));
					break;
				case "st":
					if (parameter === 'play') videoPlayer.play();
					if (parameter === 'pause') videoPlayer.pause();
					if (parameter === 'stop') videoPlayer.stop();
					break;
				case "sk":
					videoPlayer.seek(parseInt(parameter));
					break;
			}
		}
	},
	sendCommand(command, parameter) {
		webClient.socket.send(`qt:${command}:${parameter}`);
	}
};
webClient.initClient();

let mutedState = false;
let volumeState = 0;

const videoPlayer = {
	root: null,
	iframe: null,
	loaded: false,
	initPlayer() {
		videoPlayer.iframe = document.getElementsByTagName('iframe')[0];
		videoPlayer.root = videoPlayer.iframe.contentWindow;
		
		window.addEventListener('message', function (event) {
			var message = JSON.parse(event.data);
			if (message.type !== `player:currentTime`) console.log(message.type);
			if (!videoPlayer.loaded && message.type === 'player:currentTime') {
				videoPlayer.loaded = true;
			}
			if (message.type === 'player:currentTime') {
				//console.log(message.data);
				//{time: 705.99706, playerId: 'video_frame'}
			}
			if (message.type === `player:volumeChange`) {
				const newVolume = parseInt(message.data.volume);
				if (volumeState !== newVolume) {
					webClient.sendCommand("svm", newVolume);
					volumeState = newVolume;
				}
				if (mutedState !== message.data.muted) {
					webClient.sendCommand("smt", message.data.muted ? 'true' : 'false');
					mutedState = message.data.muted;
				}
			}
			if (message.type === 'player:changeState') {
				const newState = message.data.state;
				let transferState = "";
				switch (newState) {
					case `playing`:
						transferState = `play`;
						break;
					case `paused`:
						transferState = `pause`;
						break;
				}
				webClient.sendCommand("sst", transferState);
			}
		});
		

	},
	sendMethod(method, methodData) {
		videoPlayer.root.postMessage(
			JSON.stringify({
				type: 'player:' + method,
				data: methodData
			}),
			'*'
		);
	},
	volume(newVolume) {
		videoPlayer.sendMethod('setVolume', {volume: newVolume / 100});
	},
	source(path) {
		const newSource = `https://rutube.ru/play/embed/${path}`;
		videoPlayer.iframe.src = newSource;
	},
	play() {
		videoPlayer.sendMethod('play', {});
	},
	pause() {
		videoPlayer.sendMethod('pause', {});
	},
	stop() {
		videoPlayer.sendMethod('stop', {});
	},
	muted(mute) {
		videoPlayer.sendMethod(mute ? 'mute' : 'unMute', {});
	},
	seek(position) {
		videoPlayer.sendMethod('setCurrentTime', { time: position / 1000 });
	}
};
</script>
</body>